<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MIRFA Weather</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .dark-mode { background-color: #1f2937; color: white; }
    .light-mode { background-color: #f9fafb; color: #111827; }
    .card-dark { background-color: #374151; color: #e5e7eb; }
    .card-light { background-color: #ffffff; color: #111827; }
    #weatherChart { max-height: 250px; }
    .warning-card { border-left-width: 4px; }
    .temp-warning { border-left-color: #ef4444; }
    .fog-warning { border-left-color: #94a3b8; }
    .rain-warning { border-left-color: #60a5fa; }
    .warning-icon { width: 24px; height: 24px; }
  </style>
</head>
<body class="transition-colors duration-300 min-h-screen px-4 py-8">
  <div class="max-w-6xl mx-auto">
    <header class="flex justify-between items-center mb-8">
      <h1 class="text-3xl font-bold">MIRFA Weather Monitor</h1>
      <div class="flex items-center gap-3">
        <span class="text-lg">LIGHT</span>
        <label for="themeToggle" class="relative inline-flex items-center cursor-pointer">
          <input type="checkbox" id="themeToggle" class="sr-only peer">
          <div class="w-14 h-7 bg-gray-200 rounded-full peer dark:bg-gray-600 peer-focus:outline-none peer-checked:bg-blue-600"></div>
          <span class="absolute top-1 left-1 w-5 h-5 bg-white rounded-full transition-transform peer-checked:translate-x-7"></span>
        </label>
        <span class="text-lg">DARK</span>
      </div>
    </header>

    <div id="errorMsg" class="hidden p-4 mb-6 rounded-lg border text-sm bg-red-900/50 border-red-400 text-red-200"></div>

    <!-- Weather Condition Warnings -->
    <div id="weatherWarnings" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 hidden">
      <div class="warning-card temp-warning p-4 rounded-r-lg shadow-lg flex items-start gap-3">
        <svg class="warning-icon text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path fill-rule="evenodd" d="M9.401 3.003c1.155-2 4.043-2 5.197 0l7.355 12.748c1.154 2-.29 4.5-2.599 4.5H4.645c-2.309 0-3.752-2.5-2.598-4.5L9.4 3.003zM12 8.25a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75zm0 8.25a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" />
        </svg>
        <div>
          <h3 class="font-semibold">Temperature Alert</h3>
          <p id="tempWarningText" class="text-sm"></p>
        </div>
      </div>
      <div class="warning-card fog-warning p-4 rounded-r-lg shadow-lg flex items-start gap-3">
        <svg class="warning-icon text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path fill-rule="evenodd" d="M4.5 4.5a3 3 0 00-3 3v9a3 3 0 003 3h8.25a3 3 0 003-3v-9a3 3 0 00-3-3H4.5zm3 6a.75.75 0 000 1.5h1.5a.75.75 0 000-1.5H7.5zm-.75 3.75A.75.75 0 017.5 15h1.5a.75.75 0 010 1.5H7.5a.75.75 0 01-.75-.75zm3.75-.75a.75.75 0 000 1.5h1.5a.75.75 0 000-1.5h-1.5z" clip-rule="evenodd" />
        </svg>
        <div>
          <h3 class="font-semibold">Fog Risk</h3>
          <p id="fogWarningText" class="text-sm"></p>
        </div>
      </div>
      <div class="warning-card rain-warning p-4 rounded-r-lg shadow-lg flex items-start gap-3">
        <svg class="warning-icon text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm-2.625 6c-.54 0-.828.419-.936.634a1.96 1.96 0 00-.189.866c0 .298.059.605.189.866.108.215.395.634.936.634.54 0 .828-.419.936-.634.13-.26.189-.568.189-.866 0-.298-.059-.605-.189-.866-.108-.215-.395-.634-.936-.634zm4.314.634c.108-.215.395-.634.936-.634.54 0 .828.419.936.634.13.26.189.568.189.866 0 .298-.059.605-.189.866-.108.215-.395.634-.936.634-.54 0-.828-.419-.936-.634a1.96 1.96 0 01-.189-.866c0-.298.059-.605.189-.866zm2.023 6.828a.75.75 0 10-1.06-1.06 3.75 3.75 0 01-5.304 0 .75.75 0 00-1.06 1.06 5.25 5.25 0 007.424 0z" clip-rule="evenodd" />
        </svg>
        <div>
          <h3 class="font-semibold">Rain Chance</h3>
          <p id="rainWarningText" class="text-sm"></p>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
      <div class="card p-6 rounded-xl shadow-lg transition-all" id="tempCard"></div>
      <div class="card p-6 rounded-xl shadow-lg transition-all" id="humidityCard"></div>
      <div class="card p-6 rounded-xl shadow-lg transition-all" id="dewCard"></div>
      <div class="card p-6 rounded-xl shadow-lg transition-all" id="wetBulbCard"></div>
    </div>

    <div id="chartWrapper" class="p-6 rounded-xl shadow-lg mb-8">
      <h2 class="text-xl font-semibold mb-4">Temperature & Humidity History</h2>
      <div class="overflow-x-auto">
        <canvas id="weatherChart"></canvas>
      </div>
    </div>

    <div class="text-sm" id="lastUpdated">Last updated: Never</div>
  </div>

  <script>
    const API_URL = "https://esp32-api-2j8g.onrender.com"; // Flask backend
    const STALE_DATA_THRESHOLD_MS = 2 * 60 * 1000; // 2 minutes

    const themeToggle = document.getElementById('themeToggle');
    const body = document.body;
    const chartWrapper = document.getElementById('chartWrapper');
    const lastUpdated = document.getElementById('lastUpdated');
    const errorBox = document.getElementById('errorMsg');
    const weatherWarnings = document.getElementById('weatherWarnings');
    const cardIds = ['tempCard', 'humidityCard', 'dewCard', 'wetBulbCard'];

    let darkMode = localStorage.getItem('theme') !== 'light';

    function setTheme() {
      themeToggle.checked = darkMode;
      if (darkMode) {
        body.classList.add('dark-mode');
        body.classList.remove('light-mode');
        chartWrapper.className = 'p-6 rounded-xl shadow-lg mb-8 bg-gray-800 text-white';
        lastUpdated.className = 'text-sm text-gray-400';
        cardIds.forEach(id => {
          const el = document.getElementById(id);
          el.classList.add('card-dark');
          el.classList.remove('card-light');
        });
      } else {
        body.classList.remove('dark-mode');
        body.classList.add('light-mode');
        chartWrapper.className = 'p-6 rounded-xl shadow-lg mb-8 bg-white text-gray-900';
        lastUpdated.className = 'text-sm text-gray-600';
        cardIds.forEach(id => {
          const el = document.getElementById(id);
          el.classList.add('card-light');
          el.classList.remove('card-dark');
        });
      }
      localStorage.setItem('theme', darkMode ? 'dark' : 'light');
    }

    themeToggle.addEventListener('change', () => {
      darkMode = themeToggle.checked;
      setTheme();
    });

    function evaluateWeatherConditions(data) {
      const latest = data[data.length - 1];
      if (!latest) return;

      const warnings = { temp: false, fog: false, rain: false };

      if (latest.temperature >= 36) {
        document.getElementById('tempWarningText').textContent = `High temperature warning (${latest.temperature.toFixed(1)}°C) - Heat risk`;
        warnings.temp = true;
      } else if (latest.temperature <= 18) {
        document.getElementById('tempWarningText').textContent = `Low temperature warning (${latest.temperature.toFixed(1)}°C) - Wear your Jackets`;
        warnings.temp = true;
      }

      if (latest.humidity > 80 && (latest.temperature - latest.dew_point) < 2.5) {
        document.getElementById('fogWarningText').textContent = `High fog risk (Humidity: ${latest.humidity.toFixed(1)}%, Dew spread: ${(latest.temperature - latest.dew_point).toFixed(1)}°C)`;
        warnings.fog = true;
      }

      if (latest.humidity > 85 && latest.temperature > latest.dew_point) {
        const rainProbability = Math.min(100, Math.round((latest.humidity - 85) * 4));
        document.getElementById('rainWarningText').textContent = `${rainProbability}% chance of rain (Humidity: ${latest.humidity.toFixed(1)}%)`;
        warnings.rain = true;
      }

      if (warnings.temp || warnings.fog || warnings.rain) {
        weatherWarnings.classList.remove('hidden');
        document.querySelector('.temp-warning').style.display = warnings.temp ? 'flex' : 'none';
        document.querySelector('.fog-warning').style.display = warnings.fog ? 'flex' : 'none';
        document.querySelector('.rain-warning').style.display = warnings.rain ? 'flex' : 'none';
      } else {
        weatherWarnings.classList.add('hidden');
      }
    }

    async function fetchSensorData() {
      try {
        const res = await fetch(`${API_URL}/data`);
        if (!res.ok) throw new Error(`Failed to fetch data: ${res.statusText}`);

        const json = await res.json();
        const data = json.data || [];

        if (!Array.isArray(data) || data.length === 0) {
          throw new Error('No sensor data available from the API.');
        }

        const latestRecord = data[data.length - 1];
        if (!latestRecord || !latestRecord.created_at) {
          throw new Error("Received data is missing a valid timestamp.");
        }

        const recordTime = new Date(latestRecord.created_at).getTime();
        const currentTime = new Date().getTime();

        if (currentTime - recordTime > STALE_DATA_THRESHOLD_MS) {
          errorBox.textContent = '⚠️ No Data Received: The sensor has not sent new data in over 2 minutes.';
          errorBox.classList.remove('hidden');
          updateDashboard([]);
          return;
        }

        errorBox.classList.add('hidden');
        updateDashboard(data);
        evaluateWeatherConditions(data);
        lastUpdated.textContent = 'Last updated: ' + new Date().toLocaleString();
      } catch (err) {
        errorBox.textContent = `⚠️ ${err.message}`;
        errorBox.classList.remove('hidden');
        updateDashboard([]);
        weatherWarnings.classList.add('hidden');
      }
    }

    function updateDashboard(data) {
      const latest = data.length > 0 ? data[data.length - 1] : {};

      document.getElementById('tempCard').innerHTML = cardHtml('Temperature', latest.temperature, '°C');
      document.getElementById('humidityCard').innerHTML = cardHtml('Humidity', latest.humidity, '%');
      document.getElementById('dewCard').innerHTML = cardHtml('Dew Point', latest.dew_point, '°C');
      document.getElementById('wetBulbCard').innerHTML = cardHtml('Wet Bulb', latest.wet_bulb, '°C');

      const ctx = document.getElementById('weatherChart').getContext('2d');
      if (window.myChart) window.myChart.destroy();

      if (data.length > 0) {
        window.myChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.map(d => new Date(d.created_at).toLocaleTimeString()),
            datasets: [
              {
                label: 'Temperature (°C)',
                data: data.map(d => d.temperature),
                borderColor: '#f87171',
                backgroundColor: 'rgba(248,113,113,0.2)',
                tension: 0.4,
              },
              {
                label: 'Humidity (%)',
                data: data.map(d => d.humidity),
                borderColor: '#60a5fa',
                backgroundColor: 'rgba(96,165,250,0.2)',
                tension: 0.4,
                yAxisID: 'y1',
              },
            ]
          },
          options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            maintainAspectRatio: false,
            scales: {
              y: {
                type: 'linear',
                position: 'left',
                title: { display: true, text: 'Temperature (°C)' },
              },
              y1: {
                type: 'linear',
                position: 'right',
                grid: { drawOnChartArea: false },
                min: 0,
                max: 100,
                title: { display: true, text: 'Humidity (%)' },
              },
            },
          },
        });
      }
    }

    function cardHtml(title, value, unit) {
      return `
        <div class="flex justify-between items-start">
          <div>
            <h3 class="text-lg">${title}</h3>
            <p class="text-3xl font-bold mt-2">${value?.toFixed?.(1) ?? '---'}<span class="text-lg ml-1">${unit}</span></p>
          </div>
        </div>
      `;
    }

    setTheme();
    fetchSensorData();
    setInterval(fetchSensorData, 15000);
  </script>
</body>
</html>
